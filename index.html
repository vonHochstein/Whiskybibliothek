<!doctype html>
<html lang="de">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" sizes="725x725" href="img/icon_whiskydatenbank.png">
<link rel="icon" type="image/png" href="img/icon_whiskybibliothek.png">

<title>Whiskybibliothek</title>

<link rel="stylesheet" href="style.css">

<h1>Whiskybibliothek</h1>

<!-- LOGIN -->
<div id="lockscreen">
  <input id="pass" type="password" placeholder="Passwort">
  <button id="enter">Betreten</button>
  <p id="msg"></p>
</div>

<!-- CHANGELOG (wird nach Login ausgeblendet) -->
<div id="changelog" class="card" style="margin-bottom:20px">
  <h3>Changelog</h3>
  <ul>
    <li><strong>23.10.2025 16:17 Uhr:</strong> Integration eines Dashboards mit aktuell Länderverteilung und Gesamtzahl Whiskys.</li>
	<li><strong>23.10.2025 13:36 Uhr:</strong> Neue Eingabefelder in der Kartenansicht integriert (Land, Region, Flaggen). Automatische Flaggenzuweisung basierend auf Land und Region.</li>
	<li><strong>23.10.2025 12:40 Uhr:</strong> Erweiterung um neue Felder <code>country</code>, <code>region</code>, <code>flag_url</code> und <code>region_flag_url</code> in der Datenbank. Automatische Übertragung aus Spalte <em>origin</em>.</li>
	<hr class="changelog-divider">
    <li><strong>22.10.2025 13:30 Uhr:</strong> Problem Bilduploade behoben.</li>
    <hr class="changelog-divider">
    <li><strong>14.10.2025 22:10 Uhr:</strong> Beendigung Übertrag sämtlicher Daten aus der bisherigen Whisky Liste in die Datenbank</li>
    <li><strong>14.10.2025 11:04 Uhr:</strong> Neues App-Icon <em>„Whiskybibliothek“</em> erstellt und integriert (quadratisch, Gold-/Kupfer-Design; als Apple-Touch-Icon eingebunden).</li>
    <li><strong>14.10.2025 10:48 Uhr:</strong> Farbpalette „Gold Edition“ definiert (Primär: <code>#d4af37</code>, <code>#b17828</code>; Akzent: <code>#c98f38</code>; Hintergrund: <code>#1b1b1b</code>; Sekundär: <code>#2a1f16</code>; Kontrast: <code>#f5e4b5</code>; Tiefe: <code>#3a2e1f</code>).</li>
    <hr class="changelog-divider">
    <li><strong>12.10.2025 21:05 Uhr:</strong> Gesamtes CSS aus der Indexdatei ausgelagert und in <code>style.css</code> überführt. Struktur nun klar getrennt zwischen Layout und Logik, bessere Übersicht und Wartbarkeit.</li>
    <li><strong>12.10.2025 20:47 Uhr:</strong> Fehlerhafte vertikale Ausrichtung der beiden persönlichen Karten behoben → perfekte Symmetrie wiederhergestellt.</li>
    <li><strong>12.10.2025 20:21 Uhr:</strong> Tabelle <code>whiskys_new_flags</code> fertiggestellt, CSV-Import abgeschlossen (alle Flaggen entfernt, Daten bereinigt).</li>
    <li><strong>12.10.2025 20:18 Uhr:</strong> Alte Policies aus <code>whiskys</code> auf <code>whiskys_new_flags</code> übertragen; API-Zugriff für <code>anon</code> (SELECT/INSERT/UPDATE/DELETE) wieder aktiviert.</li>
    <li><strong>12.10.2025 20:12 Uhr:</strong> Fehleranalyse: leere Listenansicht nach Tabellenumbenennung → Ursache waren fehlende Row-Level-Security-Regeln.</li>
    <li><strong>12.10.2025 19:55 Uhr:</strong> Neue Import-Strategie umgesetzt (Backup → Truncate → CSV-Import in bestehende Tabelle); Ergebnis stabil und konsistent.</li>
    <li><strong>12.10.2025 19:15 Uhr:</strong> iOS-Standalone-Fix entfernt (Web-App-Modus endgültig verworfen).</li>
    <li><strong>12.10.2025 18:45 Uhr:</strong> Datenbankbereinigung abgeschlossen – alle fehlerhaften Flaggeneinträge in <code>whiskys</code> identifiziert und korrigiert; saubere CSV exportiert als Grundlage für Neuimport.</li>
    <li><strong>12.10.2025 18:10 Uhr:</strong> Ursachenanalyse für unterschiedliche Kartenhöhen in der Detailansicht</li>
    <li><strong>12.10.2025 16:50 Uhr:</strong> Testphase zur Eingabe- und Speicherlogik der Notizfelder; verschiedene Varianten (Enter blockieren, Soft-Wrap, automatische Glättung) erprobt.</li>
    <li><strong>12.10.2025 15:30 Uhr:</strong> Code-Revision von <code>renderUserBlock()</code> → Harmonisierung der Edit- und Read-Only-Darstellung.</li>
    <li><strong>12.10.2025 13:50 Uhr:</strong> Entfernung der Meta-Tags für iOS-Vollbild- und Web-App-Modus; Rückkonfiguration zur Standard-Website wegen Apple Bugs.</li>
    <li><strong>12.10.2025 12:30 Uhr:</strong> Revision und Tests des HTML-Codes</li>
    <li><strong>12.10.2025 11:20 Uhr:</strong> Technische Grundanalyse zur Implementierung der Freistellfunktion abgeschlossen; Entscheidung: Umsetzung als schlanke WebApp mit optionaler Integration in die Whisky-Apps-Seite.</li>
    <li><strong>12.10.2025 10:30 Uhr:</strong> Projektstart der geplanten Mini-WebApp zur Bildbearbeitung („Zauberstab-Funktion“) für automatisches Freistellen von Whiskyflaschen auf weißem Hintergrund (PNG-Export, Toleranzregelung, manueller Radierer geplant).</li>
    <li><strong>12.10.2025 04:25 Uhr:</strong> Rückabwicklung der iOS-WebApp-Funktion, da Apple im Standalone-Modus keine Tastatureingabe zulässt. Vollbildmodus entfernt, Seite wieder als reguläre Website konfiguriert.</li>
    <li><strong>12.10.2025 04:02 Uhr:</strong> iOS-Standalone-Fix für Passwortfeld.</li>
    <li><strong>12.10.2025 03:09 Uhr:</strong> iOS-Vollbildmodus aktiviert und App-Icon hinzugefügt. Whiskybibliothek kann nun als Web-App über den Homebildschirm geöffnet werden (ohne Safari-Adressleiste, mit eigenem Symbol).</li>
    <li><strong>12.10.2025 02:45 Uhr:</strong> Feinanpassung und Harmonisierung der Listen- und Rasterdarstellung.</li>
    <li><strong>12.10.2025 01:57 Uhr:</strong> Rasterdarstellung optimiert: Einheitliche Kachelhöhen und Abstände.</li>
    <li><strong>12.10.2025 01:35 Uhr:</strong> Dynamische Rasterdarstellung implementiert: Kartenanordnung passt sich automatisch Bildschirmbreite an (dynamische Spalten). Umschaltfunktion zwischen Listen- und Rasteransicht über Schalter neben dem Hell/Dunkel-Button hinzugefügt.</li>
    <li><strong>12.10.2025 01:04 Uhr:</strong> Überarbeitung Bewertungsfunkltion, Ergänzung Gesamtwertung (Durchschnitt).</li>
    <li><strong>12.10.2025 00:27 Uhr:</strong> Optische Optimierung der persönlichen Bewertungskarten.</li>
    <li><strong>12.10.2025 00:12 Uhr:</strong> Optische Anpassungen an Listenbildern vorgenommen (Hintergrundentfernung, Proportionen, ...).</li>
    <li><strong>12.10.2025 00:07 Uhr:</strong> Bewertungsanzeige in Listenansicht überarbeitet: Sterne untereinander in zweispaltigem Raster (Initialen AJ/PH + Durchschnitt).</li>
    <hr class="changelog-divider">
    <li><strong>11.10.2025 22:48 Uhr:</strong> Sternebewertung (1–10 Punkte → 5 Sterne â 0,5-Schritte) implementiert. Anzeige in Karteikarten und Listenansicht.</li>
    <li><strong>11.10.2025 21:04 Uhr:</strong> Sicherheitsabfrage vor Bildlöschung hinzugefügt, um versehentliches Entfernen zu verhindern.</li>
    <li><strong>11.10.2025 20:52 Uhr:</strong> Notizfelder vergrößert und automatische Höhenanpassung beim Tippen hinzugefügt (komfortableres Schreiben auf mobilen Geräten).</li>
    <li><strong>11.10.2025 19:55 Uhr:</strong> Dunkelmodus, Sortierfunktion (Bewertung/Erstell-/Änderungsdatum/Name) und Metafelder (Erstellt/Geändert + Benutzer) implementiert.</li>
    <li><strong>11.10.2025 18:45 Uhr:</strong> Lazy-Loading für Bilder aktiviert – Bilder werden erst beim Scrollen geladen, um Datenvolumen zu sparen.</li>
    <li><strong>11.10.2025 18:12 Uhr:</strong> Formular für neuen Whisky vereinheitlicht – gleiche Karteikarte wie beim Bearbeiten; sofort editierbar inkl. Bild-Upload.</li>
    <li><strong>11.10.2025 17:43 Uhr:</strong> Aufnahme Whiskykäufe Philipp Messe (#Whiskymesse_DD_2025_Kauf).</li>
    <li><strong>11.10.2025 17:14 Uhr:</strong> Whiskys aus Aberfeldy Tasting ergänzt (#Whiskymesse_DD_2025_Tasting).</li>
    <li><strong>11.10.2025 16:57 Uhr:</strong> fehlende Bilder ergänzt</li>
    <li><strong>11.10.2025 16:27 Uhr:</strong> weitere Einträge aus alter Liste hinzugefügt.</li>
    <li><strong>11.10.2025 10:52 Uhr:</strong> Anzeige der aktuellen Whisky-Gesamtzahl in der Bibliothek hinzugefügt.</li>
    <li><strong>11.10.2025 10:38 Uhr:</strong> Globale Textsuche über alle Datenbank-Felder hinzugefügt.</li>
    <li><strong>11.10.2025 09:48 Uhr:</strong> Änderungsverzeichnis hinzugefügt.</li>
    <li><strong>11.10.2025 01:20 Uhr:</strong> Beginn der Übertragung persönlicher Bewertungen aus der alten Liste.</li>
    <hr class="changelog-divider">
    <li><strong>10.10.2025 23:20 Uhr:</strong> Datenbankschema aktualisiert (<code>ALTER TABLE public.whiskys</code>); neue Bestandsfelder angelegt.</li>
    <li><strong>10.10.2025 23:05 Uhr:</strong> Allgemeines Feld <em>Bestand (%)</em> entfernt; neue individuelle Felder <code>stock_philipp</code> und <code>stock_andreas</code> hinzugefügt.</li>
    <li><strong>10.10.2025 23:00 Uhr:</strong> Individuelle Bestände integriert und getestet.</li>
    <li><strong>10.10.2025 22:45 Uhr:</strong> Bearbeitungsrechte differenziert.</li>
    <li><strong>10.10.2025 22:10 Uhr:</strong> Individuelle Bewertungsblöcke („Philipp“ / „Andreas“) reaktiviert; zweispaltiges responsives Layout.</li>
    <li><strong>10.10.2025 21:05 Uhr:</strong> Whisky-Löschfunktion mit Passwortbestätigung hinzugefügt; Datensatz + Bild werden vollständig entfernt.</li>
    <li><strong>10.10.2025 20:15 Uhr:</strong> Upload- und Löschlogik für Flaschenbilder stabilisiert; Fehler im Supabase-Bucket-Handling behoben.</li>
    <li><strong>10.10.2025 19:40 Uhr:</strong> Login-System (Philipp / Andreas) mit Passwort-Hash-Vergleich eingeführt; Whiskyliste an Login gekoppelt.</li>
    <li><strong>10.10.2025 19:00 Uhr:</strong> Karteikarten-Darstellung angelegt; Bild-Löschroutine ergänzt (automatisches Entfernen alter Bilder beim Upload).</li>
    <li><strong>10.10.2025 18:20 Uhr:</strong> Reiner Upload ohne Zuschneiden implementiert; Bilder werden direkt gespeichert und angezeigt.</li>
    <li><strong>10.10.2025 16:59 Uhr:</strong> Fehleranalyse und Bereinigung der Upload-Logik; Zuschneidefunktion vorübergehend entfernt.</li>
    <hr class="changelog-divider">
    <li><strong>09.10.2025 21:10 Uhr:</strong> Erster lauffähiger Prototyp mit Bild-Upload, Zuschneidefunktion (Cropper.js) und Speicherung der Basisdaten.</li>
    <li><strong>09.10.2025 20:11 Uhr:</strong> Erstellung der Datenbank.</li>
    <li><strong>09.10.2025 19:47 Uhr:</strong> Projektstart „Whiskydatenbank 01“; Grundstruktur mit Supabase-Anbindung und Tabellenlayout angelegt.</li>
    <hr class="changelog-divider">
    <li><strong>08.10.2025 18:00 Uhr:</strong> Erstellung der Index-Webseite (Grundgerüst des Projekts).</li>
  </ul>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="row" style="justify-content:space-between;align-items:center">
    <div>Angemeldet als <strong id="user"></strong></div>
    <div class="row" style="gap:6px">
      <button id="themeToggle" title="Hell/Dunkel">🌙</button>
      <button id="viewToggle" title="Ansicht wechseln">🧱</button>
      <button id="logout">Abmelden</button>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="showList">Liste</button>
    <button id="showAdd">Neuer Whisky</button>
	<button id="showDashboard">Dashboard</button>
    <button id="refresh">Aktualisieren</button>
  </div>

  <!-- Zähler + Suche + Sortierung -->
  <p id="whiskyCount" class="muted" style="margin-top:6px"></p>

  <div class="card search-sort" style="margin:8px 0; display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center">
    <input id="searchInput" type="text" placeholder="Suchen …"
           style="display:block;width:100%;max-width:calc(100% - 2px);box-sizing:border-box;
                  padding:8px 10px;border:1px solid var(--border);border-radius:8px;
                  font-size:1rem;background:var(--input-bg);color:var(--text);">
    <div>
      <label for="sortSelect" class="muted" style="margin-right:6px">Sortieren:</label>
      <select id="sortSelect">
        <option value="updated_desc">Änderungsdatum (neu → alt)</option>
        <option value="created_desc">Erstelldatum (neu → alt)</option>
        <option value="rating_avg_desc">Bewertung Ø (hoch → niedrig)</option>
        <option value="rating_philipp_desc">Bewertung Philipp (hoch → niedrig)</option>
        <option value="rating_andreas_desc">Bewertung Andreas (hoch → niedrig)</option>
        <option value="name_asc">Name (A → Z)</option>
      </select>
    </div>
  </div>

  <div id="content"></div>
</div>

<script type="module">
/* ---------- Konfiguration ---------- */
const SUPABASE_URL = "https://dffqempnuqymcofvgkxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmZnFlbXBudXF5bWNvZnZna3h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5OTY3NDMsImV4cCI6MjA3NTU3Mjc0M30.jHxiRy2Q2dQpvA-RuV3xcJsAy3hkDm6psYnOeNjY6pA";

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabase = supabase;

const USERS_HASH = {
  "Philipp": "bd6be2c40ce5e8a3cb66602b235a31a8497c57a74fbd7ff827853e1d396627ca",
  "Andreas": "7f894c422eebf8c5b8c38330ec4ec297668329afa365a0c1e61a097f094af3fe"
};

/* ---------- Theme ---------- */
(function initTheme(){
  const saved = localStorage.getItem("theme");
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  const useDark = saved ? (saved === "dark") : prefersDark || true; // true = Standard dunkel
  if(useDark) document.body.classList.add("dark");
})();

document.addEventListener("click",(e)=>{
  if(e.target.id==="themeToggle"){
    document.body.classList.toggle("dark");
    const isDark = document.body.classList.contains("dark");
    e.target.textContent = isDark ? "☀️" : "🌙";
    localStorage.setItem("theme", isDark ? "dark" : "light");
  }
});

/* --- Raster-/Listenansicht umschalten --- */
const viewToggle = document.getElementById("viewToggle");
let currentView = localStorage.getItem("whisky_view") || "list";
updateViewIcon();

viewToggle.addEventListener("click", () => {
  currentView = currentView === "grid" ? "list" : "grid";
  localStorage.setItem("whisky_view", currentView);
  updateViewIcon();
  renderList(getFilteredList()); // neu zeichnen
});

function updateViewIcon() {
  const content = document.getElementById("content");
  content.classList.remove("grid", "list", "listview");
  if (currentView === "grid") {
    content.classList.add("grid", "listview");
  } else {
  content.classList.add("list");
}

  viewToggle.textContent = currentView === "grid" ? "📋" : "🧱";
}

/* ---------- Login ---------- */
function buf2hex(b){return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("")}
async function sha256Hex(t){return buf2hex(await crypto.subtle.digest("SHA-256",new TextEncoder().encode(t)))}
document.getElementById("enter").onclick=async()=>{
  const pw=document.getElementById("pass").value.trim();
  const h=await sha256Hex(pw);
  const user=Object.keys(USERS_HASH).find(u=>USERS_HASH[u]===h);
  if(!user){document.getElementById("msg").textContent="Falsches Passwort.";return;}
  localStorage.setItem("whiskydb_user",user);
  showApp(user);
};
document.getElementById("logout").onclick=()=>{localStorage.removeItem("whiskydb_user");location.reload();}
const me=localStorage.getItem("whiskydb_user");if(me)showApp(me);

function showApp(name){
  document.getElementById("changelog").style.display="none";  // Changelog nach Login ausblenden
  document.getElementById("lockscreen").style.display="none";
  document.getElementById("app").style.display="";
  document.getElementById("user").textContent=name;
  // Theme-Icon initial
  document.getElementById("themeToggle").textContent = document.body.classList.contains("dark") ? "☀️" : "🌙";
  showList();
}

/* ---------- Liste ---------- */
document.getElementById("refresh").onclick=showList;
document.getElementById("showList").onclick=showList;
document.getElementById("showAdd").onclick=showAddForm;
document.getElementById("sortSelect").onchange=()=>renderList(getFilteredList());
document.getElementById("searchInput").oninput=()=>renderList(getFilteredList());

async function showList(){
  const content = document.getElementById("content");
  content.classList.remove("grid", "list", "listview");
  if (currentView === "grid") {
    content.classList.add("grid", "listview");
  } else {
    content.classList.add("list");
  }

  document.getElementById("content").innerHTML="<p>Lade Liste …</p>";
  const {data,error}=await supabase.from("whiskys").select("*").order("created_at",{ascending:false});
  if(error){document.getElementById("content").textContent=error.message;return;}
  window.allwhiskys = data || [];
  document.getElementById("whiskyCount").textContent = `${window.allwhiskys.length} Whiskys in der Bibliothek`;
  renderList(getFilteredList());
}

/* ---------- Filter + Sort ---------- */
function getFilteredList(){
  const q=(document.getElementById("searchInput").value||"").toLowerCase();
  let list = (window.allwhiskys||[]).filter(w =>
    !q || Object.values(w).some(val => val && val.toString().toLowerCase().includes(q))
  );
  return applySort(list);
}

/* ---------- Durchschnitt ---------- */
function ratingAvg(w){
  const a = parseFloat(w.rating_andreas);
  const p = parseFloat(w.rating_philipp);
  const vals = [a,p].filter(v => !isNaN(v));
  if(!vals.length) return null;
  return vals.reduce((s,v)=>s+v,0)/vals.length;
}
function applySort(list){
  const v = document.getElementById("sortSelect").value;
  const arr = [...list];
  const byDate = (a,b,key)=> new Date(b[key]||0)-new Date(a[key]||0);
  const byNumDesc = (a,b,sel)=>{
    const av = sel(a); const bv = sel(b);
    const ax = (av==null || isNaN(av)) ? -Infinity : av;
    const bx = (bv==null || isNaN(bv)) ? -Infinity : bv;
    return bx-ax;
  };
  const byStrAsc = (a,b,key)=>{
    const ax=(a[key]||"").toString().toLowerCase();
    const bx=(b[key]||"").toString().toLowerCase();
    return ax.localeCompare(bx,"de");
  };

  switch(v){
    case "updated_desc": arr.sort((a,b)=>{
      // fallback: wenn updated_at fehlt, nimm created_at
      const aKey=a.updated_at||a.created_at, bKey=b.updated_at||b.created_at;
      return new Date(bKey||0)-new Date(aKey||0);
    }); break;
    case "created_desc": arr.sort((a,b)=>byDate(a,b,"created_at")); break;
    case "rating_avg_desc": arr.sort((a,b)=>byNumDesc(a,b,ratingAvg)); break;
    case "rating_philipp_desc": arr.sort((a,b)=>byNumDesc(a,b,(x)=>parseFloat(x.rating_philipp))); break;
    case "rating_andreas_desc": arr.sort((a,b)=>byNumDesc(a,b,(x)=>parseFloat(x.rating_andreas))); break;
    case "name_asc": arr.sort((a,b)=>byStrAsc(a,b,"name")); break;
  }
  return arr;
}

/* ---------- Sterne-Helfer ---------- */
function renderStars(value, readonly = true){
  if (value == null || isNaN(value)) {
   if (readonly) return '<span class="muted">-</span>';
   // Edit-Modus: leere Sterne anzeigen
   const totalStars = 10;
   let html = '<span class="stars">';
   for (let i = 1; i <= totalStars; i++) {
     html += '<span class="star" data-val="' + i + '"></span>';
   }
   return html + '</span>';
  }

  // 5 Sterne (Anzeige) → halbe Schritte; 10 Sterne (Edit) → 1 Punkt pro Stern
  const starsHalf = Math.round((value / 2) * 2) / 2; // z.B. 7 → 3.5
  const totalStars = readonly ? 5 : 10;

  let html = '<span class="stars' + (readonly ? ' readonly' : '') + '">';
  for (let i = 1; i <= totalStars; i++) {
    if (readonly) {
      // Anzeige: 5 Sterne mit halben Schritten, data-val bleibt 2er-Skala (2,4,6,8,10)
      if (starsHalf >= i) {
        html += '<span class="star full" data-val="' + (i * 2) + '"></span>';
      } else if (starsHalf + 0.5 === i) {
        html += '<span class="star half" data-val="' + (i * 2 - 1) + '"></span>';
      } else {
        html += '<span class="star" data-val="' + (i * 2) + '"></span>';
      }
    } else {
      // Edit: 10 Sterne, jeder Stern = 1 Punkt, data-val = 1..10
      html += '<span class="star" data-val="' + i + '"></span>';
    }
  }
  html += '</span>';
  return html;
}

function updateStars(prefix, val){
  const stars = document.querySelectorAll('#' + prefix + '_stars .star');
  if (!stars.length) return;

  const total = stars.length;

  // Edit-Modus: 10 Sterne, 1 Punkt = 1 Stern
  if (total === 10) {
    const v = Math.max(0, Math.min(10, Number(val) || 0));
    stars.forEach((st, idx) => {
      st.classList.remove('half', 'full');
      st.classList.toggle('full', idx < v);
    });
    return;
  }

  // Anzeige: 5 Sterne mit halben Schritten
  const halfVal = Math.round((val / 2) * 2) / 2; // 0..5 in 0.5-Schritten
  stars.forEach((st, idx) => {
    const i = idx + 1; // 1..5
    st.classList.remove('full', 'half');
    if (halfVal >= i) st.classList.add('full');
    else if (halfVal + 0.5 === i) st.classList.add('half');
  });
}

function attachStarControls(prefix){
  const stars = document.querySelectorAll('#' + prefix + '_stars .star');
  const input = document.getElementById(prefix + '_rating');

  stars.forEach(s => {
    s.addEventListener('click', () => {
      input.value = s.dataset.val;          // 1..10 direkt setzen
      updateStars(prefix, Number(s.dataset.val));
    });
  });

  input?.addEventListener('input', () => updateStars(prefix, Number(input.value)));

  // NEU: initialen Wert visualisieren
  updateStars(prefix, Number(input?.value));
}
  
/* ---------- renderList ---------- */
function renderList(list){
  document.getElementById("whiskyCount").textContent = `${list.length} Whiskys angezeigt`;
  if(!list || !list.length){
    document.getElementById("content").innerHTML="<p class='muted'>Keine passenden Einträge gefunden.</p>";
    return;
  }
  document.getElementById("content").innerHTML=list.map(w=>{
    const a = w.rating_andreas;
    const p = w.rating_philipp;
    const avg = ratingAvg(w);
    return `
    <div class="card">
      <div class="row">
        <div style="flex:0 0 120px"><img loading="lazy" src="${w.image_url||'https://via.placeholder.com/120x150?text=No+Image'}" class="thumb"></div>
        <div style="flex:1">
          <strong>${w.name||''}</strong> ${w.distillery?("– "+w.distillery):""}<br>
			<span class="muted">
			  ${w.flag_url ? `<img src="${w.flag_url}" alt="${w.country||''}" style="height:1em;vertical-align:middle;margin-right:3px;">` : ''}
			  ${w.region && w.region_flag_url ? `<img src="${w.region_flag_url}" alt="${w.region}" style="height:1em;vertical-align:middle;margin-right:3px;">` : ''}
			  ${w.country || ''}${w.region ? ' – ' + w.region : ''}
			  ${w.age_years ? ' • ' + w.age_years + ' Jahre' : ''}
			</span><br>
          <span>${w.volume_ml??'-'} ml | ${w.abv??'-'} % vol</span><br>
          <span>Preis: ${w.price_eur!=null? (Number(w.price_eur).toFixed(2)+' €'):''} ${w.price_per_liter_eur!=null? ('('+Number(w.price_per_liter_eur).toFixed(2)+' €/L)'):''}</span><br>
          <div style="margin-top:6px; display:grid; grid-template-columns:2.2em auto; row-gap:2px; align-items:center;">
            <div style="font-size:0.85em; line-height:1;">
              <span style="vertical-align:super; font-size:0.75em;">A</span>
              <span style="vertical-align:sub; font-size:0.75em;">J</span>
            </div>
            <div>${renderStars(a)} (${a ?? '-'}/10)</div>
          
            <div style="font-size:0.85em; line-height:1;">
              <span style="vertical-align:super; font-size:0.75em;">P</span>
              <span style="vertical-align:sub; font-size:0.75em;">H</span>
            </div>
            <div>${renderStars(p)} (${p ?? '-'}/10)</div>
          
            <div>⌀</div>
            <div>${renderStars(avg)} (${avg ? (avg % 1 === 0 ? avg : avg.toFixed(1))+'/10' : '-'})</div>
          </div>
          <button data-id="${w.id}" class="viewBtn">Ansehen</button>
        </div>
      </div>
    </div>`}).join('');
  document.querySelectorAll(".viewBtn").forEach(b=>b.onclick=()=>showDetail(b.dataset.id));
}

/* ---------- Neuer Whisky: gleiche Karte im Edit-Modus ---------- */
function showAddForm(){
  const user = localStorage.getItem("whiskydb_user");
  const w = {
    id: null, name:null, distillery:null, origin:null,
    age_years:null, volume_ml:null, price_eur:null, abv:null, image_url:null,
    rating_philipp:null, notes_philipp:null, wishlist_philipp:false, stock_philipp:null,
    rating_andreas:null, notes_andreas:null, wishlist_andreas:false, stock_andreas:null,
    created_at:null, created_by:null, updated_at:null, updated_by:null
  };
  renderDetailViewForCreate(w, user);
}
function renderDetailViewForCreate(w, user){ showDetailForNew(w, user); }

async function showDetail(id) {
  document.getElementById("content").innerHTML = "<p>Lade …</p>";
  const { data, error } = await supabase.from("whiskys").select("*").eq("id", id).single();
  if (error) {document.getElementById("content").textContent = error.message;return;}
  const user = localStorage.getItem("whiskydb_user");
  renderDetailView(data, id, user, false);
}
function showDetailForNew(w, user){ renderDetailView(w, null, user, true); }

/* ---------- Dashboard ---------- */
document.getElementById("showDashboard").onclick = showDashboard;

// ---------- Platzhalter-Flagge (lokal, kein externes Laden nötig) ----------
const PLACEHOLDER_FLAG = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" viewBox="0 0 24 16">
    <rect x="0.5" y="0.5" width="23" height="15"
          fill="#f3f3f3" stroke="#d4af37" stroke-width="1"/>
    <path d="M12 4.2c1.8 0 3 1.1 3 2.6c0 1.9-2 2.2-2 3.1"
          fill="none" stroke="#8c6239" stroke-width="1.5"
          stroke-linecap="round"/>
    <circle cx="12" cy="12.6" r="0.8" fill="#8c6239"/>
  </svg>
`);

async function showDashboard() {
  const content = document.getElementById("content");
  content.classList.remove("grid", "list", "listview");
  content.classList.add("list");
  content.innerHTML = "<p>Lade Dashboard …</p>";

  // Neue Spalten: country, flag_url, age_years
  const { data, error } = await supabase
    .from("whiskys")
    .select("country, flag_url, age_years");

  if (error) {
    content.textContent = "Fehler: " + error.message;
    return;
  }

  // Länderverteilung zählen
  const counts = {};
  const flags = {};

  data.forEach(w => {
    const land = (w.country || "Unbekannt").trim();
    counts[land] = (counts[land] || 0) + 1;
    if (w.flag_url && !flags[land]) flags[land] = w.flag_url;
  });

  // Sortierung nach Anzahl absteigend
  const sorted = Object.entries(counts)
    .sort((a, b) => b[1] - a[1]); // [ [country, count], ... ]
  const countries = sorted.map(([c]) => c);
  const values = sorted.map(([, v]) => v);

  const total = data.length;

  // Dashboard-Grundaufbau
  content.innerHTML = `
    <div class="card">
      <h3>Dashboard</h3>
		<p class="whisky-count">
		  <strong>Gesamtzahl:</strong>
		  <span class="whisky-total">${total}</span>
		</p>
		<div class="country-summary">
		  ${countries.map(c => `
			<div class="country-item">
			  <img src="${flags[c] || PLACEHOLDER_FLAG}" alt="${c}" class="flag-icon">
			  <span class="country-name">${c}</span>
			  <span class="country-count">${counts[c]}</span>
			</div>
		  `).join("")}
		</div>
      <canvas id="countryChart" width="400" height="400"></canvas>
    </div>
  `;

  // Chart.js laden
  await import("https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js");

  const chartColors = [
    "#d4af37", "#b17828", "#c98f38", "#f5e4b5",
    "#2a1f16", "#3a2e1f", "#8c6239", "#deb887",
    "#ffd700", "#6b4226"
  ];

  new Chart(document.getElementById("countryChart"), {
    type: "pie",
    data: {
      labels: countries,
      datasets: [{
        data: values,
        backgroundColor: chartColors.slice(0, countries.length),
      }],
    },
    options: {
      plugins: {
        legend: { position: "bottom" },
        title: { display: true, text: "Länderverteilung" }
      }
    }
  });
}

/* ---------- Detailanzeige ---------- */
function renderDetailView(w, id, user, editing) {
  // Sicherstellen, dass Raster-Layout deaktiviert wird
  const content = document.getElementById("content");
  content.classList.remove("grid", "list", "listview");
  content.classList.add("list"); // Detailansicht = klassische Einspalten-Darstellung

  let pendingImageFile = null; // für NEU vorm INSERT

  document.getElementById("content").innerHTML = `
    <div class="card">
      <div class="row">
        <div style="flex:0 0 150px">
          <img src="${w.image_url || "https://via.placeholder.com/150x200?text=No+Image"}" class="thumb" id="imgPrev">
        </div>
          <div style="flex:1">
            ${editing
              ? `<input id="name" type="text" value="${w.name || ""}" placeholder="Whisky"><br>
                 <input id="distillery" type="text" value="${w.distillery || ""}" placeholder="Brennerei"><br>
					<select id="country" placeholder="Land wählen..." style="margin-bottom:4px;">
					  <option value="">Land wählen …</option>
					  <option value="Deutschland">Deutschland</option>
					  <option value="Schottland">Schottland</option>
					  <option value="Irland">Irland</option>
					  <option value="Nordirland">Nordirland</option>
					  <option value="USA">USA</option>
					  <option value="Japan">Japan</option>
					  <option value="Australien">Australien</option>
					  <option value="Kanada">Kanada</option>
					</select><br>

					<input id="region" type="text" value="${w.region || ""}" placeholder="Region (z. B. Highlands, Sachsen …)"><br>
					<input id="flag_url" type="url" value="${w.flag_url || ""}" placeholder="Flaggen-URL (wird meist automatisch gesetzt)"><br>
					<input id="region_flag_url" type="url" value="${w.region_flag_url || ""}" placeholder="Region-Flaggen-URL (automatisch gesetzt)"><br>
                 <input id="age_years" type="number" value="${w.age_years || ""}" placeholder="Alter (Jahre)"><br>
                 <input id="volume_ml" type="number" value="${w.volume_ml || ""}" placeholder="Volumen (ml)"><br>
                 <input id="price_eur" type="number" step="0.01" value="${w.price_eur || ""}" placeholder="Preis (€)"><br>
                 <input id="abv" type="number" step="0.1" value="${w.abv || ""}" placeholder="% vol."><br>
                 <p><strong>Bild ändern / hinzufügen:</strong></p>
                 <input type="file" id="imgUpload" accept="image/*">
                 <p id="imgMsg" class="muted"></p>
                 <p><strong>Gesamtwertung:</strong> ${renderStars(ratingAvg(w))} (${ratingAvg(w) ? Math.round(ratingAvg(w))+'/10' : '-'})</p>`
              : `<h3>${escapeHtml(w.name)}</h3>
					<p class="muted">
					  ${w.distillery || ""}
					  ${w.country || w.region ? " • " : ""}
					  ${w.flag_url ? `<img src="${w.flag_url}" alt="${w.country||''}" style="height:1em;vertical-align:middle;margin-right:3px;">` : ""}
					  ${w.region && w.region_flag_url ? `<img src="${w.region_flag_url}" alt="${w.region}" style="height:1em;vertical-align:middle;margin-right:3px;">` : ""}
					  ${w.country || ""}${w.region ? " – " + w.region : ""}
					</p>
                 <p>${w.age_years || "-"} Jahre | ${w.volume_ml || "-"} ml | ${w.abv || "-"} % vol</p>
                 <p>Preis: ${w.price_eur != null ? Number(w.price_eur).toFixed(2) + " €" : "-"} ${w.price_per_liter_eur != null ? "(" + Number(w.price_per_liter_eur).toFixed(2) + " €/L)" : ""}</p>
                 <p><strong>Gesamtwertung:</strong> ${renderStars(ratingAvg(w))} (${ratingAvg(w) ? Math.round(ratingAvg(w))+'/10' : '-'})</p>`}
          </div>
      </div>

      <!-- Zwei Karten für Philipp / Andreas -->
      <div class="two-col">
      <div class="card personal">
          <h4>Philipp</h4>
          ${renderUserBlock("philipp", user, w, editing, "Philipp")}
      </div>
      <div class="card personal">
          <h4>Andreas</h4>
          ${renderUserBlock("andreas", user, w, editing, "Andreas")}
      </div>
      </div>

      <!-- Metadaten -->
      <div class="muted" style="margin-top:10px">
        ${metaLine(w)}
      </div>

      <div style="margin-top:10px">
        ${editing
          ? `<button id="save">Speichern</button> <button id="cancel">Abbrechen</button>`
          : `<button id="edit" ${user ? "" : "style='display:none'"}>Bearbeiten</button>`}
      </div>
      <p id="detailMsg" class="muted"></p>
    </div>`;

  document.getElementById("back")?.addEventListener("click", showList);

  if (!editing && (user==="Philipp" || user==="Andreas")) {
    document.getElementById("edit").onclick = () => renderDetailView(w, id, user, true);
  }

  if (editing) {
    document.getElementById("cancel").onclick = () => { if(id==null) showList(); else renderDetailView(w, id, user, false); };

    const saveBtn = document.getElementById("save");
    saveBtn.onclick = async () => {
      let updateData = collectUpdates(w, user, true);
      document.getElementById("detailMsg").textContent = "Speichert …";

      if (id == null) {
        // INSERT mit Metadaten
        updateData.created_by = user;
        updateData.updated_by = user;
        const { data: inserted, error: insErr } = await supabase
          .from("whiskys")
          .insert(updateData)
          .select()
          .single();
        if (insErr) { document.getElementById("detailMsg").textContent = "Fehler: " + insErr.message; return; }
        const newId = inserted.id;

        // Optional Bild hochladen
        if (pendingImageFile) {
          const fileName = `whisky_${newId}_${Date.now()}.jpg`;
          const { error: uploadError } = await supabase.storage
            .from("whiskys").upload(fileName, pendingImageFile, { contentType: pendingImageFile.type, upsert:true });
          if (!uploadError) {
            const { data: publicURL } = supabase.storage.from("whiskys").getPublicUrl(fileName);
            await supabase.from("whiskys").update({ image_url: publicURL.publicUrl }).eq("id", newId);
          } else {
            document.getElementById("detailMsg").textContent = "Bild-Upload Fehler: " + uploadError.message;
          }
        }
        const { data: fresh } = await supabase.from("whiskys").select("*").eq("id", newId).single();
        renderDetailView(fresh, newId, user, false);
        return;

      } else {
        // UPDATE mit Metadaten
        updateData.updated_by = user;
        updateData.updated_at = new Date().toISOString();
        const { error } = await supabase.from("whiskys").update(updateData).eq("id", id);
        if (error) { document.getElementById("detailMsg").textContent = "Fehler: " + error.message; }
        else {
          const { data: fresh } = await supabase.from("whiskys").select("*").eq("id", id).single();
          renderDetailView(fresh, id, user, false);
        }
      }
    };

    /* ---------- Bild-Handling ---------- */
    const imgInput = document.getElementById("imgUpload");
    const imgMsg = document.getElementById("imgMsg");
    const imgPrev = document.getElementById("imgPrev");

    // Bild löschen (nur mit vorhandener ID)
    if (id != null) {
      const imgDeleteBtn = document.createElement("button");
      imgDeleteBtn.textContent = "Bild löschen";
      imgDeleteBtn.style.marginTop = "6px";
      imgDeleteBtn.style.background = "#b91c1c";
      imgDeleteBtn.style.color = "white";
      imgDeleteBtn.style.border = "none";
      imgDeleteBtn.style.padding = "6px 10px";
      imgDeleteBtn.style.borderRadius = "4px";
      imgDeleteBtn.onclick = async () => {
        if (!confirm("Bist du sicher, dass du das aktuelle Bild löschen möchtest?")) return;
      
        const currentUrl = w.image_url;
        if (!currentUrl) { imgMsg.textContent = "Kein Bild vorhanden."; return; }
      
        imgMsg.textContent = "Lösche Bild …";
        const path = currentUrl.split("/").pop();
      
        await supabase.storage.from("whiskys").remove([path]).catch(()=>{});
        await supabase.from("whiskys").update({
          image_url: null,
          updated_by: user,
          updated_at: new Date().toISOString()
        }).eq("id", id);
      
        const { data: fresh } = await supabase.from("whiskys").select("*").eq("id", id).single();
        renderDetailView(fresh, id, user, true);
      };

      imgInput?.insertAdjacentElement("afterend", imgDeleteBtn);
    }

    if (imgInput) {
      imgInput.onchange = async () => {
        const file = imgInput.files[0];
        if (!file) return;
        imgPrev.src = URL.createObjectURL(file);

        if (id == null) {
          pendingImageFile = file;
          imgMsg.textContent = "Bild wird beim Speichern hochgeladen.";
          return;
        }

        imgMsg.textContent = "Lade Bild hoch …";

        // altes Bild entfernen
        if (w.image_url) {
          const oldPath = w.image_url.split("/").pop();
          await supabase.storage.from("whiskys").remove([oldPath]).catch(()=>{});
          await supabase.from("whiskys").update({ image_url: null }).eq("id", id);
        }

        // neues hochladen
        const fileName = `whisky_${id}_${Date.now()}.jpg`;
        const { error: uploadError } = await supabase.storage
          .from("whiskys").upload(fileName, file, { contentType:file.type, upsert:true });
        if (uploadError) { imgMsg.textContent = "Fehler: " + uploadError.message; return; }

        const { data: publicURL } = supabase.storage.from("whiskys").getPublicUrl(fileName);
        await supabase.from("whiskys").update({ image_url: publicURL.publicUrl, updated_by:user, updated_at:new Date().toISOString() }).eq("id", id);
        const { data: fresh } = await supabase.from("whiskys").select("*").eq("id", id).single();
        renderDetailView(fresh, id, user, true);
        imgMsg.textContent = "Bild erfolgreich hochgeladen.";
      };
    }

    /* ---------- Whisky löschen (mit Passwort) ---------- */
    if (id != null && (user === "Philipp" || user === "Andreas")) {
      const delSection = document.createElement("div");
      delSection.style.marginTop = "15px";
      delSection.style.borderTop = "1px solid var(--border)";
      delSection.style.paddingTop = "10px";
      delSection.innerHTML = `
        <button id="deleteBtn" style="background:#b91c1c;color:white;padding:6px 10px;border:none;border-radius:4px">Whisky löschen</button>
        <div id="deleteConfirm" style="display:none;margin-top:8px">
          <p style="margin:4px 0">Zur Bestätigung Passwort eingeben:</p>
          <input id="deletePass" type="password" placeholder="Passwort">
          <button id="confirmDel">Löschen bestätigen</button>
          <button id="cancelDel">Abbrechen</button>
          <p id="delMsg" class="muted"></p>
        </div>`;
      document.querySelector(".card:last-child").appendChild(delSection);
      const wDeleteBtn = delSection.querySelector("#deleteBtn");
      const confirmDiv = delSection.querySelector("#deleteConfirm");
      const confirmBtn = delSection.querySelector("#confirmDel");
      const cancelBtn = delSection.querySelector("#cancelDel");
      const delMsg = delSection.querySelector("#delMsg");
      wDeleteBtn.onclick = () => confirmDiv.style.display = "block";
      cancelBtn.onclick = () => confirmDiv.style.display = "none";
      confirmBtn.onclick = async () => {
        const pass = confirmDiv.querySelector("#deletePass").value.trim();
        const hash = await sha256Hex(pass);
        if (USERS_HASH[user] !== hash) { delMsg.textContent = "Falsches Passwort."; return; }
        delMsg.textContent = "Lösche Eintrag …";
        if (w.image_url) {
          const path = w.image_url.split("/").pop();
          await supabase.storage.from("whiskys").remove([path]).catch(()=>{});
        }
        await supabase.from("whiskys").delete().eq("id", id);
        delMsg.textContent = "Whisky gelöscht.";
        setTimeout(showList, 1000);
      };
    }
  }

  /* ---------- Flaggen automatisch setzen ---------- */
  setTimeout(() => {
    const cSel   = document.getElementById("country");
    const fInput = document.getElementById("flag_url");
    if (cSel && fInput) {
      const base = "https://commons.wikimedia.org/wiki/Special:FilePath/";
      const map = {
        "Deutschland": "Flag_of_Germany.svg",
        "Schottland":  "Flag_of_the_United_Kingdom.svg",
		"Nordirland":  "Flag_of_the_United_Kingdom.svg",
        "Irland":      "Flag_of_Ireland.svg",
        "USA":         "Flag_of_the_United_States.svg",
        "Japan":       "Flag_of_Japan.svg",
        "Australien":  "Flag_of_Australia.svg",
        "Kanada":      "Flag_of_Canada_(Pantone).svg"
      };

      // vorhandene Werte übernehmen
      if (w.country) cSel.value = w.country;

      // wenn keine Flagge gesetzt ist, aber ein Land vorhanden → automatisch setzen
      if ((!w.flag_url || w.flag_url === "") && map[cSel.value]) {
        fInput.value = base + map[cSel.value];
      }

      // on change automatisch nachziehen
      cSel.addEventListener("change", () => {
        fInput.value = map[cSel.value] ? base + map[cSel.value] : "";
      });
    }
  }, 0);

/* ---------- Region-Flagge automatisch setzen ---------- */
setTimeout(() => {
  const rInput = document.getElementById("region");
  const rfInput = document.getElementById("region_flag_url");
  if (rInput && rfInput) {
    const base = "https://commons.wikimedia.org/wiki/Special:FilePath/";
    const map = {
      // Deutschland
      "Sachsen": "Flag_of_Saxony.svg",
      "Sachsen-Anhalt": "Flag_of_Saxony-Anhalt.svg",
      "Bayern": "Flag_of_Bavaria_(lozengy).svg",
      "Baden": "Flag_of_Baden-W%C3%BCrttemberg.svg",
      "Württemberg": "Flag_of_Baden-W%C3%BCrttemberg.svg",
      "Pfalz": "Flag_of_Rhineland-Palatinate.svg",
      "Rheinland": "Flag_of_Rhineland-Palatinate.svg",
      "Niedersachsen": "Flag_of_Lower_Saxony.svg",
      "Thüringen": "Flag_of_Thuringia.svg",
      "Brandenburg": "Flag_of_Brandenburg.svg",
      "Nordrhein": "Flag_of_North_Rhine-Westphalia.svg",
      "Westfalen": "Flag_of_North_Rhine-Westphalia.svg",
      "Saarland": "Flag_of_Saarland.svg",
      "Mecklenburg": "Flag_of_Mecklenburg-Western_Pomerania.svg",
      "Holstein": "Flag_of_Schleswig-Holstein.svg",
      "Hamburg": "Flag_of_Hamburg.svg",
      "Berlin": "Flag_of_Berlin.svg",
      "Bremen": "Flag_of_Bremen.svg",

      // Schottland / Whiskyregionen
      "Highlands": "Flag_of_Scotland.svg",
      "Speyside": "Flag_of_Scotland.svg",
      "Lowlands": "Flag_of_Scotland.svg",
      "Islay": "Flag_of_Scotland.svg",
      "Islands": "Flag_of_Scotland.svg",
      "Campbeltown": "Flag_of_Scotland.svg",
      "Schottland": "Flag_of_Scotland.svg",		

	  // Irland / Whiskyregionen
	  "Leinster": "Flag_of_Leinster.svg",
	  
	  // Nordirland / County
      "Antrim": "Flag_of_Northern_Ireland.svg",

      // USA / Kanada
      "Kentucky": "Flag_of_Kentucky.svg",
      "Manitoba": "Flag_of_Canada_(Pantone).svg",
	  "Indiana": "Flag_of_Indiana.svg"
    };

    const applyRegionFlag = () => {
      const txt = rInput.value.trim();
      const key = Object.keys(map).find(k => txt.toLowerCase().includes(k.toLowerCase()));
      rfInput.value = key ? base + map[key] : "";
    };

    // initial setzen, falls leer
    if ((!w.region_flag_url || w.region_flag_url === "") && w.region) applyRegionFlag();

    // live reagieren, sobald jemand tippt oder verlässt
    rInput.addEventListener("input", applyRegionFlag);
    rInput.addEventListener("change", applyRegionFlag);
  }
}, 0);

}


/* --------- Karte-Render-Helfer --------- */
function metaLine(w){
  const fmt = (iso)=> iso ? new Date(iso).toLocaleString("de-DE") : null;
  const ca = fmt(w.created_at); const cb = w.created_by || null;
  const ua = fmt(w.updated_at); const ub = w.updated_by || null;

  let out = "";
  if(ca || cb) out += `Erstellt${ca?' am '+ca:''}${cb?' durch '+cb:''}`;
  if(ua || ub){
    if(out) out += " • ";
    out += `Zuletzt geändert${ua?' am '+ua:''}${ub?' durch '+ub:''}`;
  }
  return out || "";
}

/**
 * Render-Logik je Karte:
 * - Philipp darf beide Karten editieren; Andreas nur seine
 */
function renderUserBlock(prefix, user, w, editing, ownerName){
  const rating = w[`rating_${prefix}`];
  const notes  = w[`notes_${prefix}`];
  const wish   = w[`wishlist_${prefix}`];
  const stock  = w[`stock_${prefix}`];
  const canEditThisCard = editing && (user === "Philipp" || user === ownerName);

    if (!canEditThisCard) {
      return `
        <p><strong>Bewertung:</strong> ${renderStars(rating)} (${rating ?? '-'}/10)</p>
        <p><strong>Notizen:</strong><br>${notes ? escapeHtml(notes) : '-'}</p>
        <p><strong>Kaufwunsch:</strong> ${wish ? '☑' : '☐'}</p>
        <p><strong>Bestand:</strong> ${stock ?? '-'} %</p>
      `;
  } else {
    // Sterne erst nach Einfügen ins DOM koppeln
    setTimeout(()=>attachStarControls(prefix), 0);
    return `
      <p>Bewertung:
        <span id="${prefix}_stars">${renderStars(rating,false)}</span>
        (<input id="${prefix}_rating" type="number" min="1" max="10" value="${rating ?? ''}" style="width:3em;">/10)
      </p>
      <p>Notizen:<br>
        <textarea id="${prefix}_notes" rows="4"
          style="width:calc(100% - 14px);min-height:80px;resize:vertical;overflow:hidden;
                margin-left:2px;white-space:pre-wrap;word-wrap:break-word;"
          onkeydown="return event.key !== 'Enter';">${notes ?? ""}</textarea>
      </p>
      <p><label><input id="${prefix}_wishlist" type="checkbox" ${wish ? "checked" : ""}> Kaufwunsch</label></p>
      <p>Bestand: <input id="${prefix}_stock" type="number" step="0.1" value="${stock ?? ""}"> %</p>
    `;
  }
}

/**
 * collectUpdates:
 * - Allgemeine Felder
 * - Individual-Felder (Philipp: beide; Andreas: nur eigene)
 */
function collectUpdates(w, user, editing){
  const upd = {};
  // alle relevanten Felder einsammeln (inkl. neue)
  ["name","distillery","country","region","flag_url","region_flag_url","age_years","volume_ml","price_eur","abv"].forEach(f=>{
    const el = document.getElementById(f);
    if (el) {
      upd[f] = el.value === "" ? null : (isNaN(el.value) ? el.value : parseFloat(el.value));
    }
  });

  const readCard = (who) => ({
    rating : numVal(`${who}_rating`),
    notes  : textVal(`${who}_notes`),
    wish   : boolVal(`${who}_wishlist`),
    stock  : numVal(`${who}_stock`)
  });

  if (user === "Philipp") {
    const p = readCard("philipp");
    const a = readCard("andreas");
    if (p.rating !== undefined)  upd.rating_philipp = p.rating;
    if (p.notes  !== undefined)  upd.notes_philipp  = p.notes;
    if (p.wish   !== undefined)  upd.wishlist_philipp = p.wish;
    if (p.stock  !== undefined)  upd.stock_philipp  = p.stock;

    if (a.rating !== undefined)  upd.rating_andreas = a.rating;
    if (a.notes  !== undefined)  upd.notes_andreas  = a.notes;
    if (a.wish   !== undefined)  upd.wishlist_andreas = a.wish;
    if (a.stock  !== undefined)  upd.stock_andreas  = a.stock;
  } else if (user === "Andreas") {
    const a = readCard("andreas");
    if (a.rating !== undefined)  upd.rating_andreas = a.rating;
    if (a.notes  !== undefined)  upd.notes_andreas  = a.notes;
    if (a.wish   !== undefined)  upd.wishlist_andreas = a.wish;
    if (a.stock  !== undefined)  upd.stock_andreas  = a.stock;
  }
  return upd;
}


/* Utils */
function numVal(id){
  const e = document.getElementById(id);
  return e ? (e.value === "" ? null : (parseFloat(e.value) || null)) : undefined;
}

function textVal(id){
  const e = document.getElementById(id);
  return e ? (e.value.trim() === "" ? null : e.value.trim()) : undefined;
}

function boolVal(id){
  const e = document.getElementById(id);
  return e ? !!e.checked : undefined;
}

function escapeHtml(s){
  return s
    ? String(s).replace(/[&<>"']/g, c =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
      )
    : '';
}

// automatische Größenanpassung für Textfelder
document.addEventListener("input", (e) => {
  if (e.target.tagName.toLowerCase() === "textarea") {
    e.target.style.height = "auto";
    e.target.style.height = (e.target.scrollHeight) + "px";
  }
});

</script>
</html>
