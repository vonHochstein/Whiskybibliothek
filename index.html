<!doctype html>
<html lang="de">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Whiskybibliothek</title>

<style>
  :root{
    --bg:#fafafa; --text:#222; --muted:#666; --card:#fff; --border:#ddd;
    --input-bg:#fff; --btn-bg:#eee; --btn-text:#222;
  }
  body.dark{
    --bg:#1e1e1e; --text:#f5f5f5; --muted:#aaaaaa; --card:#2a2a2a; --border:#444;
    --input-bg:#222; --btn-bg:#333; --btn-text:#f5f5f5;
  }

  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;background:var(--bg);color:var(--text)}
  h1,h2,h3{margin:.4em 0}
  input,textarea,button,select{font-size:1rem;padding:6px;margin:4px 0;color:var(--text);background:var(--input-bg)}
  .row{display:flex;flex-wrap:wrap;gap:8px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  .muted{color:var(--muted);font-size:.9rem}
  button{background:var(--btn-bg);color:var(--btn-text);border:1px solid var(--border);border-radius:6px;cursor:pointer}
  button:hover{filter:brightness(0.98)}
  /* Number-Spinner ausblenden */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  @media (max-width:768px){.two-col{grid-template-columns:1fr;}}
  .field{margin-bottom:6px}
  img.thumb{width:100%;max-width:220px;border-radius:6px;object-fit:cover}

  @media (max-width: 600px) {
  .search-sort {
    grid-template-columns: 1fr !important;
  }
  .search-sort select {
    width: 100%;
  }
}

  /* Sterne-Bewertung (halbe Sterne) */
  .stars{display:inline-block;font-size:1.05rem;line-height:1;color:#d4af37;vertical-align:middle}
  .star{cursor:pointer;display:inline-block;width:1.1em;position:relative}
  .star::before{content:'\2605';opacity:0.32}
  .star.full::before{opacity:1}
  .star.half::before{
    background:linear-gradient(90deg,#d4af37 50%,transparent 50%);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    opacity:1
  }
  .stars.readonly .star{cursor:default}
</style>

<h1>Whiskybibliothek</h1>

<!-- LOGIN -->
<div id="lockscreen">
  <input id="pass" type="password" placeholder="Passwort">
  <button id="enter">Betreten</button>
  <p id="msg"></p>
</div>

<!-- CHANGELOG (wird nach Login ausgeblendet) -->
<div id="changelog" class="card" style="margin-bottom:20px">
  <h3>Changelog</h3>
  <ul>
    <li><strong>11.10.2025 22:48 Uhr:</strong> Sternebewertung (1‚Äì10 Punkte ‚Üí 5 Sterne √¢ 0,5-Schritte) implementiert. Anzeige in Karteikarten und Listenansicht.</li>
    <li><strong>11.10.2025 21:04 Uhr:</strong> Sicherheitsabfrage vor Bildl√∂schung hinzugef√ºgt, um versehentliches Entfernen zu verhindern.</li>
    <li><strong>11.10.2025 20:52 Uhr:</strong> Notizfelder vergr√∂√üert und automatische H√∂henanpassung beim Tippen hinzugef√ºgt (komfortableres Schreiben auf mobilen Ger√§ten).</li>
    <li><strong>11.10.2025 19:55 Uhr:</strong> Dunkelmodus, Sortierfunktion (Bewertung/Erstell-/√Ñnderungsdatum/Name) und Metafelder (Erstellt/Ge√§ndert + Benutzer) implementiert.</li>
    <li><strong>11.10.2025 18:45 Uhr:</strong> Lazy-Loading f√ºr Bilder aktiviert ‚Äì Bilder werden erst beim Scrollen geladen, um Datenvolumen zu sparen.</li>
    <li><strong>11.10.2025 18:12 Uhr:</strong> Formular f√ºr neuen Whisky vereinheitlicht ‚Äì gleiche Karteikarte wie beim Bearbeiten; sofort editierbar inkl. Bild-Upload.</li>
    <li><strong>11.10.2025 17:43 Uhr:</strong> Aufnahme Whiskyk√§ufe Philipp Messe (#Whiskymesse_DD_2025_Kauf).</li>
    <li><strong>11.10.2025 17:14 Uhr:</strong> Whiskys aus Aberfeldy Tasting erg√§nzt (#Whiskymesse_DD_2025_Tasting).</li>
    <li><strong>11.10.2025 16:57 Uhr:</strong> fehlende Bilder erg√§nzt</li>
    <li><strong>11.10.2025 16:27 Uhr:</strong> weitere Eintr√§ge aus alter Liste hinzugef√ºgt.</li>
    <li><strong>11.10.2025 10:52 Uhr:</strong> Anzeige der aktuellen Whisky-Gesamtzahl in der Bibliothek hinzugef√ºgt.</li>
    <li><strong>11.10.2025 10:38 Uhr:</strong> Globale Textsuche √ºber alle Datenbank-Felder hinzugef√ºgt.</li>
    <li><strong>11.10.2025 09:48 Uhr:</strong> √Ñnderungsverzeichnis hinzugef√ºgt.</li>
    <li><strong>11.10.2025 01:20 Uhr:</strong> Beginn der √úbertragung pers√∂nlicher Bewertungen aus der alten Liste.</li>
    <li><strong>10.10.2025 23:20 Uhr:</strong> Datenbankschema aktualisiert (<code>ALTER TABLE public.whiskies</code>); neue Bestandsfelder angelegt.</li>
    <li><strong>10.10.2025 23:05 Uhr:</strong> Allgemeines Feld <em>Bestand (%)</em> entfernt; neue individuelle Felder <code>stock_philipp</code> und <code>stock_andreas</code> hinzugef√ºgt.</li>
    <li><strong>10.10.2025 23:00 Uhr:</strong> Individuelle Best√§nde integriert und getestet.</li>
    <li><strong>10.10.2025 22:45 Uhr:</strong> Bearbeitungsrechte differenziert.</li>
    <li><strong>10.10.2025 22:10 Uhr:</strong> Individuelle Bewertungsbl√∂cke (‚ÄûPhilipp‚Äú / ‚ÄûAndreas‚Äú) reaktiviert; zweispaltiges responsives Layout.</li>
    <li><strong>10.10.2025 21:05 Uhr:</strong> Whisky-L√∂schfunktion mit Passwortbest√§tigung hinzugef√ºgt; Datensatz + Bild werden vollst√§ndig entfernt.</li>
    <li><strong>10.10.2025 20:15 Uhr:</strong> Upload- und L√∂schlogik f√ºr Flaschenbilder stabilisiert; Fehler im Supabase-Bucket-Handling behoben.</li>
    <li><strong>10.10.2025 19:40 Uhr:</strong> Login-System (Philipp / Andreas) mit Passwort-Hash-Vergleich eingef√ºhrt; Whiskyliste an Login gekoppelt.</li>
    <li><strong>10.10.2025 19:00 Uhr:</strong> Karteikarten-Darstellung angelegt; Bild-L√∂schroutine erg√§nzt (automatisches Entfernen alter Bilder beim Upload).</li>
    <li><strong>10.10.2025 18:20 Uhr:</strong> Reiner Upload ohne Zuschneiden implementiert; Bilder werden direkt gespeichert und angezeigt.</li>
    <li><strong>10.10.2025 16:59 Uhr:</strong> Fehleranalyse und Bereinigung der Upload-Logik; Zuschneidefunktion vor√ºbergehend entfernt.</li>
    <li><strong>09.10.2025 21:10 Uhr:</strong> Erster lauff√§higer Prototyp mit Bild-Upload, Zuschneidefunktion (Cropper.js) und Speicherung der Basisdaten.</li>
    <li><strong>09.10.2025 20:11 Uhr:</strong> Erstellung der Datenbank.</li>
    <li><strong>09.10.2025 19:47 Uhr:</strong> Projektstart ‚ÄûWhiskydatenbank 01‚Äú; Grundstruktur mit Supabase-Anbindung und Tabellenlayout angelegt.</li>
    <li><strong>08.10.2025 18:00 Uhr:</strong> Erstellung der Index-Webseite (Grundger√ºst des Projekts).</li>
  </ul>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="row" style="justify-content:space-between;align-items:center">
    <div>Angemeldet als <strong id="user"></strong></div>
    <div class="row" style="gap:6px">
      <button id="themeToggle" title="Hell/Dunkel">üåô</button>
      <button id="logout">Abmelden</button>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="showList">Liste</button>
    <button id="showAdd">Neuer Whisky</button>
    <button id="refresh">Aktualisieren</button>
  </div>

  <!-- Z√§hler + Suche + Sortierung -->
  <p id="whiskyCount" class="muted" style="margin-top:6px"></p>

  <div class="card search-sort" style="margin:8px 0; display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center">
    <input id="searchInput" type="text" placeholder="Suchen ‚Ä¶"
           style="display:block;width:100%;max-width:calc(100% - 2px);box-sizing:border-box;
                  padding:8px 10px;border:1px solid var(--border);border-radius:8px;
                  font-size:1rem;background:var(--input-bg);color:var(--text);">
    <div>
      <label for="sortSelect" class="muted" style="margin-right:6px">Sortieren:</label>
      <select id="sortSelect">
        <option value="updated_desc">√Ñnderungsdatum (neu ‚Üí alt)</option>
        <option value="created_desc">Erstelldatum (neu ‚Üí alt)</option>
        <option value="rating_avg_desc">Bewertung √ò (hoch ‚Üí niedrig)</option>
        <option value="rating_philipp_desc">Bewertung Philipp (hoch ‚Üí niedrig)</option>
        <option value="rating_andreas_desc">Bewertung Andreas (hoch ‚Üí niedrig)</option>
        <option value="name_asc">Name (A ‚Üí Z)</option>
      </select>
    </div>
  </div>

  <div id="content"></div>
</div>

<script type="module">
/* ---------- Konfiguration ---------- */
const SUPABASE_URL = "https://dffqempnuqymcofvgkxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmZnFlbXBudXF5bWNvZnZna3h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5OTY3NDMsImV4cCI6MjA3NTU3Mjc0M30.jHxiRy2Q2dQpvA-RuV3xcJsAy3hkDm6psYnOeNjY6pA";

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabase = supabase;

const USERS_HASH = {
  "Philipp": "bd6be2c40ce5e8a3cb66602b235a31a8497c57a74fbd7ff827853e1d396627ca",
  "Andreas": "7f894c422eebf8c5b8c38330ec4ec297668329afa365a0c1e61a097f094af3fe"
};

/* ---------- Theme ---------- */
(function initTheme(){
  const saved = localStorage.getItem("theme");
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  const useDark = saved ? (saved === "dark") : prefersDark || true; // true = Standard dunkel
  if(useDark) document.body.classList.add("dark");
})();

document.addEventListener("click",(e)=>{
  if(e.target.id==="themeToggle"){
    document.body.classList.toggle("dark");
    const isDark = document.body.classList.contains("dark");
    e.target.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", isDark ? "dark" : "light");
  }
});

/* ---------- Login ---------- */
function buf2hex(b){return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("")}
async function sha256Hex(t){return buf2hex(await crypto.subtle.digest("SHA-256",new TextEncoder().encode(t)))}
document.getElementById("enter").onclick=async()=>{
  const pw=document.getElementById("pass").value.trim();
  const h=await sha256Hex(pw);
  const user=Object.keys(USERS_HASH).find(u=>USERS_HASH[u]===h);
  if(!user){document.getElementById("msg").textContent="Falsches Passwort.";return;}
  localStorage.setItem("whiskydb_user",user);
  showApp(user);
};
document.getElementById("logout").onclick=()=>{localStorage.removeItem("whiskydb_user");location.reload();}
const me=localStorage.getItem("whiskydb_user");if(me)showApp(me);

function showApp(name){
  document.getElementById("changelog").style.display="none";  // Changelog nach Login ausblenden
  document.getElementById("lockscreen").style.display="none";
  document.getElementById("app").style.display="";
  document.getElementById("user").textContent=name;
  // Theme-Icon initial
  document.getElementById("themeToggle").textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
  showList();
}

/* ---------- Liste ---------- */
document.getElementById("refresh").onclick=showList;
document.getElementById("showList").onclick=showList;
document.getElementById("showAdd").onclick=showAddForm;
document.getElementById("sortSelect").onchange=()=>renderList(getFilteredList());
document.getElementById("searchInput").oninput=()=>renderList(getFilteredList());

async function showList(){
  document.getElementById("content").innerHTML="<p>Lade Liste ‚Ä¶</p>";
  const {data,error}=await supabase.from("whiskies").select("*").order("created_at",{ascending:false});
  if(error){document.getElementById("content").textContent=error.message;return;}
  window.allWhiskies = data || [];
  document.getElementById("whiskyCount").textContent = `${window.allWhiskies.length} Whiskys in der Bibliothek`;
  renderList(getFilteredList());
}

/* ---------- Filter + Sort ---------- */
function getFilteredList(){
  const q=(document.getElementById("searchInput").value||"").toLowerCase();
  let list = (window.allWhiskies||[]).filter(w =>
    !q || Object.values(w).some(val => val && val.toString().toLowerCase().includes(q))
  );
  return applySort(list);
}
function ratingAvg(w){
  const a = parseFloat(w.rating_andreas);
  const p = parseFloat(w.rating_philipp);
  const vals = [a,p].filter(v => !isNaN(v));
  if(!vals.length) return null;
  return vals.reduce((s,v)=>s+v,0)/vals.length;
}
function applySort(list){
  const v = document.getElementById("sortSelect").value;
  const arr = [...list];
  const byDate = (a,b,key)=> new Date(b[key]||0)-new Date(a[key]||0);
  const byNumDesc = (a,b,sel)=>{
    const av = sel(a); const bv = sel(b);
    const ax = (av==null || isNaN(av)) ? -Infinity : av;
    const bx = (bv==null || isNaN(bv)) ? -Infinity : bv;
    return bx-ax;
  };
  const byStrAsc = (a,b,key)=>{
    const ax=(a[key]||"").toString().toLowerCase();
    const bx=(b[key]||"").toString().toLowerCase();
    return ax.localeCompare(bx,"de");
  };

  switch(v){
    case "updated_desc": arr.sort((a,b)=>{
      // fallback: wenn updated_at fehlt, nimm created_at
      const aKey=a.updated_at||a.created_at, bKey=b.updated_at||b.created_at;
      return new Date(bKey||0)-new Date(aKey||0);
    }); break;
    case "created_desc": arr.sort((a,b)=>byDate(a,b,"created_at")); break;
    case "rating_avg_desc": arr.sort((a,b)=>byNumDesc(a,b,ratingAvg)); break;
    case "rating_philipp_desc": arr.sort((a,b)=>byNumDesc(a,b,(x)=>parseFloat(x.rating_philipp))); break;
    case "rating_andreas_desc": arr.sort((a,b)=>byNumDesc(a,b,(x)=>parseFloat(x.rating_andreas))); break;
    case "name_asc": arr.sort((a,b)=>byStrAsc(a,b,"name")); break;
  }
  return arr;
}

/* ---------- Sterne-Helfer ---------- */
function renderStars(value, readonly=true){
  if(value==null || isNaN(value)) return '<span class="muted">-</span>';
  const stars = Math.round((value/2)*2)/2; // auf halbe Schritte runden
  let html = '<span class="stars' + (readonly?' readonly':'') + '">';
  const totalStars = readonly ? 5 : 10;
  for(let i=1; i<=totalStars; i++){
    if(stars>=i) html += '<span class="star full" data-val="'+(i*2)+'"></span>';
    else if(stars+0.5===i) html += '<span class="star half" data-val="'+(i*2-1)+'"></span>';
    else html += '<span class="star" data-val="'+(i*2)+'"></span>';
  }
  return html + '</span>';
}
function updateStars(prefix,val){
  const stars=document.querySelectorAll('#'+prefix+'_stars .star');
  if(!stars.length) return;
  const starsVal=Math.round((val/2)*2)/2;
  stars.forEach(st=>{
    const i=parseInt(st.dataset.val,10)/2;
    st.classList.remove('full','half');
    if(starsVal>=i) st.classList.add('full');
    else if(starsVal+0.5===i) st.classList.add('half');
  });
}
function attachStarControls(prefix){
  const stars=document.querySelectorAll('#'+prefix+'_stars .star');
  const input=document.getElementById(prefix+'_rating');
  stars.forEach(s=>{
    s.addEventListener('click',()=>{
      input.value = s.dataset.val;
      updateStars(prefix, parseFloat(s.dataset.val));
    });
  });
  input?.addEventListener('input',()=>updateStars(prefix, parseFloat(input.value)));
}

/* ---------- renderList ---------- */
function renderList(list){
  document.getElementById("whiskyCount").textContent = `${list.length} Whiskys angezeigt`;
  if(!list || !list.length){
    document.getElementById("content").innerHTML="<p class='muted'>Keine passenden Eintr√§ge gefunden.</p>";
    return;
  }
  document.getElementById("content").innerHTML=list.map(w=>{
    const a = w.rating_andreas;
    const p = w.rating_philipp;
    const avg = ratingAvg(w);
    return `
    <div class="card">
      <div class="row">
        <div style="flex:0 0 120px"><img loading="lazy" src="${w.image_url||'https://via.placeholder.com/120x150?text=No+Image'}" class="thumb"></div>
        <div style="flex:1">
          <strong>${w.name||''}</strong> ${w.distillery?("‚Äì "+w.distillery):""}<br>
          <span class="muted">${w.origin||''} ${w.age_years?("‚Ä¢ "+w.age_years+" Jahre"):""}</span><br>
          <span>${w.volume_ml??'-'} ml | ${w.abv??'-'} % vol</span><br>
          <span>Preis: ${w.price_eur!=null? (Number(w.price_eur).toFixed(2)+' ‚Ç¨'):''} ${w.price_per_liter_eur!=null? ('('+Number(w.price_per_liter_eur).toFixed(2)+' ‚Ç¨/L)'):''}</span><br>
          <span>
            A=${a??'-'} ${renderStars(a)} / 
            P=${p??'-'} ${renderStars(p)} / 
            ‚åÄ${avg?avg.toFixed(1):'-'}/10 ${renderStars(avg)}
          </span><br>
          <button data-id="${w.id}" class="viewBtn">Ansehen</button>
        </div>
      </div>
    </div>`}).join('');
  document.querySelectorAll(".viewBtn").forEach(b=>b.onclick=()=>showDetail(b.dataset.id));
}

/* ---------- Neuer Whisky: gleiche Karte im Edit-Modus ---------- */
function showAddForm(){
  const user = localStorage.getItem("whiskydb_user");
  const w = {
    id: null, name:null, distillery:null, origin:null,
    age_years:null, volume_ml:null, price_eur:null, abv:null, image_url:null,
    rating_philipp:null, notes_philipp:null, wishlist_philipp:false, stock_philipp:null,
    rating_andreas:null, notes_andreas:null, wishlist_andreas:false, stock_andreas:null,
    created_at:null, created_by:null, updated_at:null, updated_by:null
  };
  renderDetailViewForCreate(w, user);
}
function renderDetailViewForCreate(w, user){ showDetailForNew(w, user); }

async function showDetail(id) {
  document.getElementById("content").innerHTML = "<p>Lade ‚Ä¶</p>";
  const { data, error } = await supabase.from("whiskies").select("*").eq("id", id).single();
  if (error) {document.getElementById("content").textContent = error.message;return;}
  const user = localStorage.getItem("whiskydb_user");
  renderDetailView(data, id, user, false);
}
function showDetailForNew(w, user){ renderDetailView(w, null, user, true); }

/* ---------- Detailanzeige ---------- */
function renderDetailView(w, id, user, editing) {
  let pendingImageFile = null; // f√ºr NEU vorm INSERT

  document.getElementById("content").innerHTML = `
    <div class="card">
      <div class="row">
        <div style="flex:0 0 150px">
          <img src="${w.image_url || "https://via.placeholder.com/150x200?text=No+Image"}" class="thumb" id="imgPrev">
        </div>
        <div style="flex:1">
          ${editing
            ? `<input id="name" value="${w.name || ""}" placeholder="Whisky"><br>
               <input id="distillery" value="${w.distillery || ""}" placeholder="Brennerei"><br>
               <input id="origin" value="${w.origin || ""}" placeholder="Herkunft"><br>
               <input id="age_years" type="number" value="${w.age_years || ""}" placeholder="Alter (Jahre)"><br>
               <input id="volume_ml" type="number" value="${w.volume_ml || ""}" placeholder="Volumen (ml)"><br>
               <input id="price_eur" type="number" step="0.01" value="${w.price_eur || ""}" placeholder="Preis (‚Ç¨)"><br>
               <input id="abv" type="number" step="0.1" value="${w.abv || ""}" placeholder="% vol."><br>
               <p><strong>Bild √§ndern / hinzuf√ºgen:</strong></p>
               <input type="file" id="imgUpload" accept="image/*">
               <p id="imgMsg" class="muted"></p>`
            : `<h3>${escapeHtml(w.name)}</h3>
               <p class="muted">${w.distillery || ""} ${w.origin ? "‚Ä¢ " + w.origin : ""}</p>
               <p>${w.age_years || "-"} Jahre | ${w.volume_ml || "-"} ml | ${w.abv || "-"} % vol</p>
               <p>Preis: ${w.price_eur != null ? Number(w.price_eur).toFixed(2) + " ‚Ç¨" : "-"} ${w.price_per_liter_eur != null ? "(" + Number(w.price_per_liter_eur).toFixed(2) + " ‚Ç¨/L)" : ""}</p>`}
        </div>
      </div>

      <!-- Zwei Karten f√ºr Philipp / Andreas -->
      <div class="two-col">
        <div class="card">
          <h4>Philipp</h4>
          ${renderUserBlock("philipp", user, w, editing, "Philipp")}
        </div>
        <div class="card">
          <h4>Andreas</h4>
          ${renderUserBlock("andreas", user, w, editing, "Andreas")}
        </div>
      </div>

      <!-- Metadaten -->
      <div class="muted" style="margin-top:10px">
        ${metaLine(w)}
      </div>

      <div style="margin-top:10px">
        ${editing
          ? `<button id="save">Speichern</button> <button id="cancel">Abbrechen</button>`
          : `<button id="edit" ${user ? "" : "style='display:none'"}>Bearbeiten</button>`}
        ${id != null ? `<button id="back">Zur√ºck</button>` : ""}
      </div>
      <p id="detailMsg" class="muted"></p>
    </div>`;

  document.getElementById("back")?.addEventListener("click", showList);

  if (!editing && (user==="Philipp" || user==="Andreas")) {
    document.getElementById("edit").onclick = () => renderDetailView(w, id, user, true);
  }

  if (editing) {
    document.getElementById("cancel").onclick = () => { if(id==null) showList(); else renderDetailView(w, id, user, false); };

    const saveBtn = document.getElementById("save");
    saveBtn.onclick = async () => {
      let updateData = collectUpdates(w, user, true);
      document.getElementById("detailMsg").textContent = "Speichert ‚Ä¶";

      if (id == null) {
        // INSERT mit Metadaten
        updateData.created_by = user;
        updateData.updated_by = user;
        const { data: inserted, error: insErr } = await supabase
          .from("whiskies")
          .insert(updateData)
          .select()
          .single();
        if (insErr) { document.getElementById("detailMsg").textContent = "Fehler: " + insErr.message; return; }
        const newId = inserted.id;

        // Optional Bild hochladen
        if (pendingImageFile) {
          const fileName = `whisky_${newId}_${Date.now()}.jpg`;
          const { error: uploadError } = await supabase.storage
            .from("whiskies").upload(fileName, pendingImageFile, { contentType: pendingImageFile.type, upsert:true });
          if (!uploadError) {
            const { data: publicURL } = supabase.storage.from("whiskies").getPublicUrl(fileName);
            await supabase.from("whiskies").update({ image_url: publicURL.publicUrl }).eq("id", newId);
          } else {
            document.getElementById("detailMsg").textContent = "Bild-Upload Fehler: " + uploadError.message;
          }
        }
        const { data: fresh } = await supabase.from("whiskies").select("*").eq("id", newId).single();
        renderDetailView(fresh, newId, user, false);
        return;

      } else {
        // UPDATE mit Metadaten
        updateData.updated_by = user;
        updateData.updated_at = new Date().toISOString();
        const { error } = await supabase.from("whiskies").update(updateData).eq("id", id);
        if (error) { document.getElementById("detailMsg").textContent = "Fehler: " + error.message; }
        else {
          const { data: fresh } = await supabase.from("whiskies").select("*").eq("id", id).single();
          renderDetailView(fresh, id, user, false);
        }
      }
    };

    /* ---------- Bild-Handling ---------- */
    const imgInput = document.getElementById("imgUpload");
    const imgMsg = document.getElementById("imgMsg");
    const imgPrev = document.getElementById("imgPrev");

    // Bild l√∂schen (nur mit vorhandener ID)
    if (id != null) {
      const imgDeleteBtn = document.createElement("button");
      imgDeleteBtn.textContent = "Bild l√∂schen";
      imgDeleteBtn.style.marginTop = "6px";
      imgDeleteBtn.style.background = "#b91c1c";
      imgDeleteBtn.style.color = "white";
      imgDeleteBtn.style.border = "none";
      imgDeleteBtn.style.padding = "6px 10px";
      imgDeleteBtn.style.borderRadius = "4px";
      imgDeleteBtn.onclick = async () => {
        if (!confirm("Bist du sicher, dass du das aktuelle Bild l√∂schen m√∂chtest?")) return;
      
        const currentUrl = w.image_url;
        if (!currentUrl) { imgMsg.textContent = "Kein Bild vorhanden."; return; }
      
        imgMsg.textContent = "L√∂sche Bild ‚Ä¶";
        const path = currentUrl.split("/").pop();
      
        await supabase.storage.from("whiskies").remove([path]).catch(()=>{});
        await supabase.from("whiskies").update({
          image_url: null,
          updated_by: user,
          updated_at: new Date().toISOString()
        }).eq("id", id);
      
        const { data: fresh } = await supabase.from("whiskies").select("*").eq("id", id).single();
        renderDetailView(fresh, id, user, true);
      };

      imgInput?.insertAdjacentElement("afterend", imgDeleteBtn);
    }

    if (imgInput) {
      imgInput.onchange = async () => {
        const file = imgInput.files[0];
        if (!file) return;
        imgPrev.src = URL.createObjectURL(file);

        if (id == null) {
          pendingImageFile = file;
          imgMsg.textContent = "Bild wird beim Speichern hochgeladen.";
          return;
        }

        imgMsg.textContent = "Lade Bild hoch ‚Ä¶";

        // altes Bild entfernen
        if (w.image_url) {
          const oldPath = w.image_url.split("/").pop();
          await supabase.storage.from("whiskies").remove([oldPath]).catch(()=>{});
          await supabase.from("whiskies").update({ image_url: null }).eq("id", id);
        }

        // neues hochladen
        const fileName = `whisky_${id}_${Date.now()}.jpg`;
        const { error: uploadError } = await supabase.storage
          .from("whiskies").upload(fileName, file, { contentType:file.type, upsert:true });
        if (uploadError) { imgMsg.textContent = "Fehler: " + uploadError.message; return; }

        const { data: publicURL } = supabase.storage.from("whiskies").getPublicUrl(fileName);
        await supabase.from("whiskies").update({ image_url: publicURL.publicUrl, updated_by:user, updated_at:new Date().toISOString() }).eq("id", id);
        const { data: fresh } = await supabase.from("whiskies").select("*").eq("id", id).single();
        renderDetailView(fresh, id, user, true);
        imgMsg.textContent = "Bild erfolgreich hochgeladen.";
      };
    }

    /* ---------- Whisky l√∂schen (mit Passwort) ---------- */
    if (id != null && (user === "Philipp" || user === "Andreas")) {
      const delSection = document.createElement("div");
      delSection.style.marginTop = "15px";
      delSection.style.borderTop = "1px solid var(--border)";
      delSection.style.paddingTop = "10px";
      delSection.innerHTML = `
        <button id="deleteBtn" style="background:#b91c1c;color:white;padding:6px 10px;border:none;border-radius:4px">Whisky l√∂schen</button>
        <div id="deleteConfirm" style="display:none;margin-top:8px">
          <p style="margin:4px 0">Zur Best√§tigung Passwort eingeben:</p>
          <input id="deletePass" type="password" placeholder="Passwort">
          <button id="confirmDel">L√∂schen best√§tigen</button>
          <button id="cancelDel">Abbrechen</button>
          <p id="delMsg" class="muted"></p>
        </div>`;
      document.querySelector(".card:last-child").appendChild(delSection);
      const wDeleteBtn = delSection.querySelector("#deleteBtn");
      const confirmDiv = delSection.querySelector("#deleteConfirm");
      const confirmBtn = delSection.querySelector("#confirmDel");
      const cancelBtn = delSection.querySelector("#cancelDel");
      const delMsg = delSection.querySelector("#delMsg");
      wDeleteBtn.onclick = () => confirmDiv.style.display = "block";
      cancelBtn.onclick = () => confirmDiv.style.display = "none";
      confirmBtn.onclick = async () => {
        const pass = confirmDiv.querySelector("#deletePass").value.trim();
        const hash = await sha256Hex(pass);
        if (USERS_HASH[user] !== hash) { delMsg.textContent = "Falsches Passwort."; return; }
        delMsg.textContent = "L√∂sche Eintrag ‚Ä¶";
        if (w.image_url) {
          const path = w.image_url.split("/").pop();
          await supabase.storage.from("whiskies").remove([path]).catch(()=>{});
        }
        await supabase.from("whiskies").delete().eq("id", id);
        delMsg.textContent = "Whisky gel√∂scht.";
        setTimeout(showList, 1000);
      };
    }
  }
}

/* --------- Karte-Render-Helfer --------- */
function metaLine(w){
  const fmt = (iso)=> iso ? new Date(iso).toLocaleString("de-DE") : null;
  const ca = fmt(w.created_at); const cb = w.created_by || null;
  const ua = fmt(w.updated_at); const ub = w.updated_by || null;

  let out = "";
  if(ca || cb) out += `Erstellt${ca?' am '+ca:''}${cb?' durch '+cb:''}`;
  if(ua || ub){
    if(out) out += " ‚Ä¢ ";
    out += `Zuletzt ge√§ndert${ua?' am '+ua:''}${ub?' durch '+ub:''}`;
  }
  return out || "";
}

/**
 * Render-Logik je Karte:
 * - Philipp darf beide Karten editieren; Andreas nur seine
 */
function renderUserBlock(prefix, user, w, editing, ownerName){
  const rating = w[`rating_${prefix}`];
  const notes  = w[`notes_${prefix}`];
  const wish   = w[`wishlist_${prefix}`];
  const stock  = w[`stock_${prefix}`];
  const canEditThisCard = editing && (user === "Philipp" || user === ownerName);

  if (!canEditThisCard) {
    return `
      <p>Bewertung: ${rating ?? "-"} ${renderStars(rating)}</p>
      <p>Notizen:<br>${notes ? escapeHtml(notes) : "-"}</p>
      <p>Kaufwunsch: ${wish ? "‚òë" : "‚òê"}</p>
      <p>Bestand: ${stock ?? "-"} %</p>
    `;
  } else {
    // Sterne erst nach Einf√ºgen ins DOM koppeln
    setTimeout(()=>attachStarControls(prefix), 0);
    return `
      <p>Bewertung: <input id="${prefix}_rating" type="number" min="1" max="10" value="${rating ?? ""}">
      <span id="${prefix}_stars">${renderStars(rating,false)}</span></p>
      <p>Notizen:<br>
      <textarea id="${prefix}_notes" rows="4"
        style="width:calc(100% - 14px);min-height:80px;resize:vertical;overflow:hidden;
               margin-left:2px;">${notes ?? ""}</textarea>
      </p>
      <p><label><input id="${prefix}_wishlist" type="checkbox" ${wish ? "checked" : ""}> Kaufwunsch</label></p>
      <p>Bestand: <input id="${prefix}_stock" type="number" step="0.1" value="${stock ?? ""}"> %</p>
    `;
  }
}

/**
 * collectUpdates:
 * - Allgemeine Felder
 * - Individual-Felder (Philipp: beide; Andreas: nur eigene)
 */
function collectUpdates(w, user, editing){
  const upd = {};
  ["name","distillery","origin","age_years","volume_ml","price_eur","abv"].forEach(f=>{
    const el=document.getElementById(f);
    if(el) upd[f] = el.value === "" ? null : (isNaN(el.value)? el.value : parseFloat(el.value));
  });

  const readCard = (who) => ({
    rating : numVal(`${who}_rating`),
    notes  : textVal(`${who}_notes`),
    wish   : boolVal(`${who}_wishlist`),
    stock  : numVal(`${who}_stock`)
  });

  if (user === "Philipp") {
    const p = readCard("philipp");
    const a = readCard("andreas");
    if (p.rating !== undefined)  upd.rating_philipp = p.rating;
    if (p.notes  !== undefined)  upd.notes_philipp  = p.notes;
    if (p.wish   !== undefined)  upd.wishlist_philipp = p.wish;
    if (p.stock  !== undefined)  upd.stock_philipp  = p.stock;

    if (a.rating !== undefined)  upd.rating_andreas = a.rating;
    if (a.notes  !== undefined)  upd.notes_andreas  = a.notes;
    if (a.wish   !== undefined)  upd.wishlist_andreas = a.wish;
    if (a.stock  !== undefined)  upd.stock_andreas  = a.stock;
  } else if (user === "Andreas") {
    const a = readCard("andreas");
    if (a.rating !== undefined)  upd.rating_andreas = a.rating;
    if (a.notes  !== undefined)  upd.notes_andreas  = a.notes;
    if (a.wish   !== undefined)  upd.wishlist_andreas = a.wish;
    if (a.stock  !== undefined)  upd.stock_andreas  = a.stock;
  }
  return upd;
}

/* Utils */
function numVal(id){const e=document.getElementById(id);return e? (e.value===""?null:(parseFloat(e.value)||null)) : undefined;}
function textVal(id){const e=document.getElementById(id);return e? (e.value.trim()===""?null:e.value.trim()) : undefined;}
function boolVal(id){const e=document.getElementById(id);return e? !!e.checked : undefined;}
function escapeHtml(s){return s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):'';}

// automatische Gr√∂√üenanpassung f√ºr Textfelder
document.addEventListener("input", (e) => {
  if (e.target.tagName.toLowerCase() === "textarea") {
    e.target.style.height = "auto";
    e.target.style.height = (e.target.scrollHeight) + "px";
  }
});  

</script>
</html>
