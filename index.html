<!doctype html>
<html lang="de">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhiskyDB – Login</title>

<h1>WhiskyDB – Login / Registrierung</h1>

<section id="auth">
  <input id="email" type="email" placeholder="E-Mail" />
  <input id="password" type="password" placeholder="Passwort" />
  <br>
  <button id="login">Login</button>
  <button id="signup">Registrieren</button>
  <button id="logout" style="display:none">Abmelden</button>
  <p id="msg"></p>
</section>

<section id="app" style="display:none">
  <h2>Angemeldet als <span id="user-email"></span></h2>
  <button id="addMode">Neuen Whisky anlegen</button>
  <ul id="list"></ul>
</section>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://svlcylawdtszcoucxjrv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2bGN5bGF3ZHRzemNvdWN4anJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzM0MjcsImV4cCI6MjA3NTU0OTQyN30.odTM2YKHDOJ0HD18mphNjEvbaGACKgWvoUJqalAAbgI";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --- Prüfen, ob Recovery-Link aufgerufen wurde ---
  const hashParams = new URLSearchParams(window.location.hash.substring(1));
  const accessToken = hashParams.get("access_token");
  const type = hashParams.get("type");
  
  if (type === "recovery" && accessToken) {
    document.body.innerHTML = `
      <h2>Neues Passwort festlegen</h2>
      <input id="newPass" type="password" placeholder="Neues Passwort" />
      <button id="setPass">Speichern</button>
      <p id="msg"></p>
    `;
  
    const msg = (t) => document.getElementById("msg").textContent = t;
  
    document.getElementById("setPass").onclick = async () => {
      const newPassword = document.getElementById("newPass").value.trim();
      if (!newPassword) return msg("Bitte neues Passwort eingeben.");
  
      // Session anhand des Tokens initialisieren
      const { error: sessErr } = await supabase.auth.setSession({
        access_token: accessToken,
        refresh_token: accessToken
      });
      if (sessErr) return msg("Fehler beim Authentifizieren: " + sessErr.message);
  
      // Passwort aktualisieren
      const { error } = await supabase.auth.updateUser({ password: newPassword });
      if (error) return msg("Fehler: " + error.message);
  
      msg("Passwort erfolgreich geändert. Du kannst dich jetzt neu einloggen.");
    };
  
    // hier stoppen, damit die normale App nicht weiterlädt
    throw new Error("Stop further execution after password reset screen");
  }

  const $ = (id) => document.getElementById(id);
  const msg = (t) => { $("msg").textContent = t; };

  async function refreshSession() {
    const { data: { session } } = await supabase.auth.getSession();
    const loggedIn = !!session;
    $("logout").style.display = loggedIn ? "" : "none";
    $("app").style.display = loggedIn ? "" : "none";
    $("login").style.display = loggedIn ? "none" : "";
    $("signup").style.display = loggedIn ? "none" : "";
    if (loggedIn) {
      $("user-email").textContent = session.user.email;
      loadWhiskies();
    } else {
      $("user-email").textContent = "";
      $("list").innerHTML = "";
    }
  }

  $("login").onclick = async () => {
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return msg("Bitte E-Mail und Passwort eingeben.");
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) msg("Fehler: " + error.message);
    else msg("Erfolgreich eingeloggt.");
    refreshSession();
  };

  $("signup").onclick = async () => {
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return msg("Bitte E-Mail und Passwort eingeben.");
    const { error } = await supabase.auth.signUp({ email, password });
    msg(error ? ("Fehler: " + error.message) : "Konto angelegt. Du bist eingeloggt.");
    refreshSession();
  };

  $("logout").onclick = async () => {
    await supabase.auth.signOut();
    msg("Abgemeldet.");
    refreshSession();
  };

  async function loadWhiskies() {
    const { data, error } = await supabase
      .from("whiskies")
      .select("id, name, distillery, origin, rating, price_eur, price_per_liter_eur")
      .order("created_at", { ascending: false })
      .limit(50);
    if (error) return msg("Fehler: " + error.message);
    $("list").innerHTML = (data || []).map(w =>
      `<li><strong>${w.name}</strong> ${w.distillery ? "– " + w.distillery : ""} | ` +
      `${w.origin || ""} | ⭐ ${w.rating || "-"} | ` +
      `${w.price_eur ? w.price_eur.toFixed(2) + "€" : "-"} ` +
      `${w.price_per_liter_eur ? "(" + w.price_per_liter_eur.toFixed(2) + "€/L)" : ""}</li>`
    ).join("");
  }

  supabase.auth.onAuthStateChange(() => refreshSession());
  refreshSession();
</script>
</html>
